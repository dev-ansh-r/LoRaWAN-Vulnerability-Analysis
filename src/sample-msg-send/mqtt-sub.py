import paho.mqtt.client as mqtt
import json

# MQTT broker settings
broker_address = "broker.emqx.io"  # Replace with the address of your MQTT broker
broker_port = 1883  # Adjust the port if necessary
topic = "application/app1/device/dev1/up"  # Replace with your actual topic

# Callback when a message is received
def on_message(client, userdata, msg):
    print("Received message on topic: {}".format(msg.topic))
    try:
        # Decode the JSON message
        payload = json.loads(msg.payload.decode("utf-8"))
        # Display the decoded message
        print(json.dumps(payload, indent=2))
    except json.JSONDecodeError as e:
        print("Error decoding JSON: {}".format(e))

# Set up the MQTT client
client = mqtt.Client()

# Set the callback function for received messages
client.on_message = on_message

# Connect to the broker
client.connect(broker_address, broker_port)

# Subscribe to the specified topic
client.subscribe(topic)

# Start the MQTT loop to listen for messages
client.loop_start()

# Keep the program running to allow time for receiving messages
try:
    while True:
        pass
except KeyboardInterrupt:
    # Disconnect from the broker when the program is interrupted
    client.loop_stop()
    client.disconnect()
    print("Disconnected from the broker")
